#!/bin/sh
#Script to fetch CIM schema for sfcb.

trap "rm -f /tmp/cimv290.zip" exit 

function usage()
{
    echo usage: $1 [schemadir] >&2
}

args=`getopt f $*`

if [ $? != 0 ]
then
    usage $0
    exit 1
fi

set -- $args

force=0
while [ -n "$1" ]
do
  case $1 in
      -f) force=1
	  shift;;
      --) shift;
	  break;;
  esac
done

if [ $# == 1 ]; then
    sfcbdir=$1
elif [ $# == 0 ]; then
    sfcbdir=@datadir@/sfcb
else
    usage $0
    exit 1
fi

if [ -x /usr/bin/curl ] 
then
   if [ ! -f $sfcbdir/CIM/CIM_Schema.mof ] || [ $force == 1 ]
   then
      echo "Fetching CIM Schema from DMTF homepage ..."
      if [ -d $sfcbdir/CIM ]
      then
	  rm -rf $sfcbdir/CIM
	  if [ $? != 0 ]
	  then
	      echo "Failed to delete schema directory $sfcbdir/CIM" >&2
	      exit 1
	  fi
      fi
      mkdir -p $sfcbdir/CIM
      if [ $? == 0 ]; then
	  /usr/bin/curl -o /tmp/cimv290.zip \
 http://www.dmtf.org/standards/cim/cim_schema_v29/CIM_V2.9.0Final-MOFs.zip &&
	  unzip -jd $sfcbdir/CIM /tmp/cimv290.zip &&
	  exit 0
      fi
      echo "Failed to fetch and install CIM schema" 1>&2 
   else
      echo "CIM Schema already present - nothing to do."
      exit 0
   fi   
else
    echo "Need curl to get CIM schema files." 1>&2
    exit 1
fi
